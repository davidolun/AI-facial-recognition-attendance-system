<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Student</title>
  <style>
    :root { --w: 1200px; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
      background: #0b0e13; 
      color: #e5e7eb; 
      margin: 0; 
      padding: 2rem; 
    }
    h1 { 
      margin: 0 0 1rem; 
      font-size: 1.8rem; 
      font-weight: 600; 
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .wrap { max-width: var(--w); margin: 0 auto; }
    
    .nav-links {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .nav-links a {
      color: #3b82f6;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid #374151;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .nav-links a:hover {
      background: #1f2937;
      border-color: #3b82f6;
    }
    
    .form-section {
      background: #111827;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #d1d5db;
    }
    
    input[type="text"], input[type="email"], input[type="tel"] {
      width: 100%;
      padding: 0.75rem;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 10px;
      color: #e5e7eb;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    
    .required {
      color: #ef4444;
    }
    
    .cam {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border: 1px solid #1f2937;
      border-radius: 16px;
      overflow: hidden;
      background: #111827;
      margin: 1rem 0;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    
    .controls {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    button {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #1f2937;
      border-color: #3b82f6;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .primary-btn {
      background: #3b82f6;
      border-color: #3b82f6;
    }
    
    .primary-btn:hover:not(:disabled) {
      background: #2563eb;
    }
    
    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 10px;
      font-size: 0.95rem;
      text-align: center;
    }
    
    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      white-space: pre-line;
    }
    
    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    .status.processing {
      background: rgba(245, 158, 11, 0.2);
      border: 2px solid #f59e0b;
      color: #fbbf24;
      font-weight: bold;
      animation: processingPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes processingPulse {
      0%, 100% { 
        background: rgba(245, 158, 11, 0.2);
        border-color: #f59e0b;
        transform: scale(1);
      }
      50% { 
        background: rgba(245, 158, 11, 0.3);
        border-color: #fbbf24;
        transform: scale(1.02);
      }
    }
    
    .preview-section {
      text-align: center;
    }
    
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
      
      .cam {
        aspect-ratio: 4/3;
        min-height: 300px;
      }
    }
  </style>
</head>
<body>
  {% include 'includes/sidebar.html' %}
  
  <div class="wrap">
    <div class="nav-links">
      <a href="/">ðŸ“· Take Attendance</a>
      <a href="/add_student/" style="background: #1f2937; border-color: #3b82f6;">ðŸ‘¤ Add Student</a>
      <a href="/dashboard/">ðŸ“Š View Records</a>
      <a href="/advanced_analytics/">ðŸ“ˆ Advanced Analytics</a>
      <a href="/class_management/">ðŸ‘¥ Class Management</a>
      <a href="/ai_assistant/">ðŸ¤– AI Assistant</a>
    </div>
    
    <h1>ðŸ‘¤ Add New Student (AWS Rekognition)</h1>
    
    <div class="form-section">
      <div class="form-group">
        <label for="studentName">Student Name <span class="required">*</span></label>
        <input type="text" id="studentName" placeholder="Enter full name" required />
      </div>
      
      <div class="form-row">
        <!-- Student ID field hidden - auto-generated -->
        <div class="form-group" style="display: none;">
          <label for="studentId">Student ID (Optional)</label>
          <input type="text" id="studentId" placeholder="e.g., STU001" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label for="phone">Phone (Optional)</label>
          <input type="tel" id="phone" placeholder="e.g., +1234567890" />
        </div>
      </div>
      
      <div class="form-group">
        <label for="email">Email (Optional)</label>
        <input type="email" id="email" placeholder="student@school.com" />
      </div>
    </div>
    
    <div class="form-section preview-section">
      <h3 style="margin-top: 0; color: #d1d5db;">ðŸ“¸ Take Photo</h3>
      <p style="color: #9ca3af; margin-bottom: 1rem;">Position yourself clearly in the camera frame with good lighting</p>
      
      <div class="cam">
        <video id="webcam" autoplay playsinline muted></video>
      </div>
      
      <div class="controls">
        <button id="start">Start Camera</button>
        <button id="stop" disabled>Stop Camera</button>
        <button id="capture" class="primary-btn" disabled>ðŸ“¸ Add Student</button>
      </div>
    </div>
    
    <div id="status" class="status info">Click "Start Camera" to begin</div>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <!-- Include Onboarding System -->
  <script src="/static/js/onboarding.js"></script>

  <script>
    const video = document.getElementById("webcam");
    const canvas = document.getElementById("canvas");
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const captureBtn = document.getElementById("capture");
    const statusEl = document.getElementById("status");
    let stream;

    console.log('ðŸš€ Add Student page initialized with AWS Rekognition');

    function dispatchStudentAddedEvent(name, studentId) {
      console.log('=== DISPATCHING STUDENT ADDED EVENT ===');
      console.log('Student Name:', name);
      console.log('Student ID:', studentId);
      
      const event = new CustomEvent('studentAdded', {
        detail: { 
          studentName: name, 
          studentId: studentId 
        },
        bubbles: true,
        cancelable: true
      });
      document.dispatchEvent(event);
      console.log('âœ… studentAdded event dispatched');
    }

    async function startCamera() {
      try {
        statusEl.textContent = "Starting camera...";
        statusEl.className = "status info";
        
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: {ideal: 1280}, height: {ideal: 720} },
          audio: false
        });
        
        video.srcObject = stream;
        await video.play();
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        captureBtn.disabled = false;
        
        statusEl.textContent = "âœ… Camera is live. Position yourself in the frame and click 'Add Student'";
        statusEl.className = "status success";
        
        console.log('âœ… Camera started successfully');
        
      } catch(err) {
        console.error('âŒ Camera error:', err);
        statusEl.textContent = "Error: " + (err.message || err.name);
        statusEl.className = "status error";
      }
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      captureBtn.disabled = true;
      statusEl.textContent = "Camera stopped. Click 'Start Camera' to begin";
      statusEl.className = "status info";
      console.log('ðŸ›‘ Camera stopped');
    }

    function captureStudent() {
  const name = document.getElementById("studentName").value.trim();
  const studentId = document.getElementById("studentId").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  
  if (!name) {
    statusEl.textContent = "âŒ Please enter student name";
    statusEl.className = "status error";
    document.getElementById("studentName").focus();
    return;
  }

  console.log('ðŸ“¸ Capturing student photo...');
  console.log('Name:', name);
  console.log('Student ID:', studentId || 'Auto-generated');

  statusEl.textContent = "ðŸ”„ Processing with AWS Rekognition... Please wait";
  statusEl.className = "status processing";
  captureBtn.disabled = true;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = canvas.toDataURL("image/png");
  console.log('ðŸ“· Image captured, sending to server...');

  fetch("/add_student/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({
      name: name,
      student_id: studentId,
      email: email,
      phone: phone,
      image: imageData
    })
  })
  .then(response => {
    console.log('ðŸ“¡ Server response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('ðŸ“¦ Server response:', data);
    
    if (data.error) {
      console.error('âŒ Error from server:', data.error);
      statusEl.textContent = "âŒ Error: " + data.error;
      statusEl.className = "status error";
      statusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      console.log('âœ… Student added successfully!');
      statusEl.textContent = "âœ… " + data.message;
      statusEl.className = "status success";
      
      // âœ… FIX: Check if onboarding is active before scrolling
      const isOnboardingActive = window.onboardingSystem && window.onboardingSystem.isActive;
      
      if (isOnboardingActive) {
        // During onboarding: scroll to TOP (navigation area) instead of status
        console.log('ðŸŽ¯ Onboarding active - scrolling to navigation');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        // Normal operation: scroll to status message
        statusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Trigger onboarding event
      dispatchStudentAddedEvent(name, studentId || data.student_id);
      
      // Clear form
      document.getElementById("studentName").value = "";
      document.getElementById("studentId").value = "";
      document.getElementById("email").value = "";
      document.getElementById("phone").value = "";
      
      // Stop camera after delay (only if not in onboarding)
      if (!isOnboardingActive) {
        setTimeout(() => {
          stopCamera();
        }, 2000);
      }
    }
  })
  .catch(err => {
    console.error('âŒ Network error:', err);
    statusEl.textContent = "âŒ Network error: " + err.message;
    statusEl.className = "status error";
    statusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  })
  .finally(() => {
    captureBtn.disabled = false;
  });
}




    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(c => {
          if (c.trim().startsWith(name + "=")) {
            cookieValue = decodeURIComponent(c.trim().substring(name.length + 1));
          }
        });
      }
      return cookieValue;
    }

    startBtn.addEventListener("click", startCamera);
    stopBtn.addEventListener("click", stopCamera);
    captureBtn.addEventListener("click", captureStudent);
    
    // Auto-start camera
    setTimeout(() => {
        console.log('ðŸŽ¬ Auto-starting camera...');
        startCamera();
    }, 100);
    
    // Focus on name input
    document.getElementById("studentName").focus();
    
    console.log('âœ… Add Student page loaded with AWS Rekognition');
    console.log('Onboarding system present:', !!window.onboardingSystem);
  </script>
</body>
</html>